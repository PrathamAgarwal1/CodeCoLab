<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeCoLab</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material-darker.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'styles/room.css' %}">
</head>
<body>
    <div class="top-bar">
        <div class="logo">
            <i class="fas fa-leaf"></i>
            <span>CodeCoLab</span>
        </div>
        <div class="room-info">
            <span id="roomId"><i class="fas fa-hashtag"></i>{{ room_name }}</span>
            <span id="userCount"><i class="fas fa-users"></i><span id="count">{{ room.participants.count }}</span> Users</span>
        </div>
        <div class="user-controls">
            <div class="user-avatar" id="userAvatar">{{ request.user.username|slice:":2"|upper }}</div>
            <span id="username">{{ request.user.username }}</span>
        </div>
    </div>

    <div class="workspace">
        <div class="sidebar">
            <div class="sidebar-tabs">
                <button class="tab-btn active" data-tab="participantsTab"><i class="fas fa-users"></i></button>
                <button class="tab-btn" data-tab="chatTab"><i class="fas fa-comments"></i></button>
                <button class="tab-btn" data-tab="aiTab"><i class="fas fa-robot"></i></button>
            </div>
            <div class="sidebar-content">
                <div id="participantsTab" class="tab-content active">
                    <h3>Participants</h3>
                    <div id="participantsList" class="participants-list">
                        {% for participant in room.participants.all %}
                        <div class="participant">
                            <div class="participant-avatar">{{ participant.username|slice:":2"|upper }}</div>
                            <div class="participant-name">{{ participant.username }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div id="chatTab" class="tab-content">
                    <div id="chatMessages" class="chat-messages">
                        {% for message in chat_messages %}
                        <div class="message {% if message.user == request.user %}sent{% else %}received{% endif %}">
                            <div class="message-content">
                                <span class="sender">{{ message.user.username }}:</span>
                                <span class="content">{{ message.content }}</span>
                            </div>
                            <div class="time">{{ message.timestamp|date:"g:i A" }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="Type a message...">
                        <button id="sendMessage"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
                <div id="aiTab" class="tab-content">
                    <div id="aiMessages" class="ai-messages"></div>
                    <div class="ai-input">
                        <input type="text" id="aiChatInput" placeholder="Ask AI for help...">
                        <button id="sendToAI"><i class="fas fa-robot"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="editor-panel">
            <div class="editor-toolbar">
                <select id="languageSelect">
                    <option value="javascript">JavaScript</option>
                    <option value="python">Python</option>
                    <option value="htmlmixed">HTML</option>
                    <option value="css">CSS</option>
                </select>
                <button id="runCode">Run</button>
                <button id="saveCode">Save</button>
                <button id="shareCode">Share</button>
            </div>
            <div class="editor-container">
                <textarea id="codeEditor">{{ room.code_content }}</textarea>
            </div>
            <div class="output-area"></div>
        </div>

        <div class="video-panel">
            <div class="video-grid">
                <div class="video-container">
                    <video id="localVideo" autoplay muted playsinline></video>
                    <div class="video-info">
                        <div class="name">You</div>
                        <div class="controls">
                            <button id="toggleLocalCamera"><i class="fas fa-video"></i></button>
                            <button id="toggleLocalMic"><i class="fas fa-microphone"></i></button>
                        </div>
                    </div>
                </div>
                <div class="video-container">
                    <video id="remoteVideo" autoplay playsinline></video>
                    <div class="video-info">
                        <div class="name">Peer</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="control-bar">
        <button id="toggleCamera"><i class="fas fa-video"></i></button>
        <button id="toggleMic"><i class="fas fa-microphone"></i></button>
        <button id="toggleScreenShare"><i class="fas fa-desktop"></i></button>
        <button id="toggleFullScreen"><i class="fas fa-expand"></i></button>
        <button id="endCall" class="danger"><i class="fas fa-phone-slash"></i></button>
    </div>

    <!-- CSRF Token for AJAX requests -->
    <script>
        const CSRF_TOKEN = "{{ csrf_token }}";
        const ROOM_ID = "{{ room.id }}";
        const USERNAME = "{{ request.user.username }}";
    </script>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/javascript-hint.min.js"></script>

    <!-- Application Scripts -->
    <script src="{% static 'js/main.js' %}" type="module"></script>
    <script src="{% static 'js/editor.js' %}"></script>
    <script src="{% static 'js/chat.js' %}" type="module"></script>
    <script src="{% static 'js/ai-chat.js' %}"></script>
    <script src="{% static 'js/webrtc.js' %}" type="module"></script>
    <script src="{% static 'js/media-controls.js' %}"></script>
    <script src="{% static 'js/controls.js' %}"></script>
    <script src="{% static 'js/ai.js' %}"></script>
</body>
</html>